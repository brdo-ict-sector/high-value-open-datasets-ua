---
title: "Публікації наборів даних високої цінності на Порталі відкритих даних"
format: html
editor: visual
---

```{r}
#| include: false

library(tidyverse)
library(readxl)
library(gt)
library(scales)

setwd("C:/Users/MykolaKuzin/OneDrive - NGO 'BETTER REGULATION DELIVERY OFFICE'/Desktop/projects/open_data/postanova_835/Q4 2025/clean data")

list.files()

excel_sheets('13_result_table_for_viz - 2025-11-11.xlsx')

my_table <- read_xlsx('13_result_table_for_viz - 2025-11-11.xlsx', sheet = 'q2_25_prep')

names(my_table)

df <- my_table |> filter(high_value == TRUE)

df <- df |> filter(!dataset_id %in% 'cae2c166-cd6f-4094-8f16-09cae3721759') # це двічі той самий набір у апарата ВР

# це 2 набори, які не побачили при первинному зведеднні

  # Реєстр затверджених експортних потужностей

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "available_dataset"] <- 'Реєстр затверджених експортних потужностей'

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "dataset_id"] <- 'f29d71d0-19dd-4663-8935-4d402fac6574'

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "status"] <- 'наявний'

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "update_frequency"] <- 'no longer updated'

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "last_update"] <- as.Date('2020-03-16')

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "created"] <- as.Date('2025-02-28')

df[df$required_dataset == 'Реєстр затверджених експортних потужностей (об’єктів)*', "on_time_update"] <- 'не оновлюється'

 # Інформація з автоматизованої системи виконавчого провадження

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "available_dataset"] <- 'Інформація з автоматизованої системи виконавчого провадження'

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "dataset_id"] <- '22aef563-3e87-4ed9-92e8-d764dc02f426'

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "status"] <- 'наявний'

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "update_frequency"] <- 'immediately after making changes'

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "last_update"] <- as.Date('2019-12-12')

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "created"] <- as.Date('2025-11-01')

df[df$required_dataset == 'Інформація з автоматизованої системи виконавчого провадження*', "on_time_update"] <- 'вчасно'



package_formats <- read_xlsx('13_result_table_for_viz - 2025-11-11.xlsx', sheet = 'package_formats')

high_value_packs_id <- df |> 
  distinct(dataset_id) |> 
  filter(!is.na(dataset_id)) |> 
  as_vector() 

package_formats <- package_formats |> filter(dataset_id %in% high_value_packs_id)
```

```{r}
#| include: false

package_formats <- package_formats |> 
  left_join(df |> select(dataset_id, org_name_postanova, required_dataset), 
            join_by(dataset_id))

df |> distinct(org_name_postanova) |> nrow()

```

У вересневих змінах до постанови КМУ № 835 з'явилося поняття "наборів даних високої цінності", що має таке визначення:

> [набір даних високої цінності](https://zakon.rada.gov.ua/laws/show/835-2015-%D0%BF#n2613 "перейти до постанови") - набір даних, який містить суспільно необхідну інформацію, повторне використання якої становить значний ефект для розвитку суспільства, держави, економіки та захисту навколишнього природного середовища;

Загалом постанова зобов'язує `r df |> distinct(org_name_postanova) |> nrow()` розпорядників оприлюднити `r df |> distinct(org_name_postanova, required_dataset) |> nrow()` набори високої цінності.

BRDO проаналізував повноту оприлюднення цих наборів розпорядниками, вчасність оновлення та використовувані формати файлів (ресурсів). Інформація зібрана станом на 01 листопада 2025 року, для збору використали API Порталу відкритих даних. Отримані для цього аналізу дані викладені [тут у табличному форматі](https://github.com/brdo-ict-sector/high-value-open-datasets-ua/tree/main/data). Проєкт на GitHub доступний за [цим посиланням](https://github.com/brdo-ict-sector/high-value-open-datasets-ua).

### Перелік наборів високої цінності

Нижче наведено повний перелік наборів даних високої цінності, що підлягають оприлюдненню згідно з постановою:

```{r}
#| include: false
table1 <- 
df |> 
  select(
    Розпорядник = org_name_postanova, 
    Набір = required_dataset,
    `Статус публікації` = status) |> 
  arrange(Розпорядник) |>
  mutate(`#` = dense_rank(Розпорядник),
        `#_набору` = row_number(Розпорядник),
        `Статус публікації` = if_else(`Статус публікації` == 'наявний',
                                  'оприлюднений',
                                  `Статус публікації`)) |>
  select(`#`, Розпорядник, `#_набору`, Набір, `Статус публікації`)
```

```{r}
#| echo: false

color_green <- "#E8F5E9"
color_red <- "#FFEBEE"

table1 |>
  gt() |>
  tab_style(
    style = cell_fill(color = color_green),
    locations = cells_body(
      columns = `Статус публікації`,
      rows = `Статус публікації` == "оприлюднений"
    )
  ) |>
  tab_style(
    style = cell_fill(color = color_red),
    locations = cells_body(
      columns = `Статус публікації`,
      rows = `Статус публікації` == "відсутній"
    )
  ) |>
  tab_style(
    style = cell_borders(
      sides = "bottom",
      color = "gray80",
      weight = px(1.5),
      style = "solid"
    ),
    locations = cells_body(
      # Note: This logic relies on the data being sorted by #
      rows = `#` != lead(`#`, default = -1)
    )
  ) |>
  # 4. FIXED: Bold text for specific columns using tab_style instead of cols_body
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = c(`#`, Розпорядник)
    )
  ) |>
  tab_header(
    title = md("**Статус публікації наборів даних**")
  ) |>
  cols_align(
    align = "center",
    columns = matches("^#")
  ) |>
  cols_align(
    align = "left",
    columns = c(Розпорядник, Набір, `Статус публікації`)
  ) |>
  tab_options(
    column_labels.font.weight = "bold",
    table.border.top.color = "gray50",
    table.border.bottom.color = "gray50",
    table_body.border.bottom.color = "gray90",
    data_row.padding = px(5) 
  )
```

### Статистика оприлюднення наборів

```{r}
#| include: false
published_data <-   
  df |> 
    select(
      Розпорядник = org_name_postanova, 
      Набір = required_dataset,
      available_dataset,
      on_time_update) |>
    mutate(
      aux1 = if_else(is.na(available_dataset), 0, 1),
      `Підлягають оприлюдненню` = n(),
      `Оприлюднено наборів` = sum(aux1),
      `Оприлюднено вчасно` = sum(on_time_update == 'вчасно' | on_time_update == 'оновлення після зміни даних'),
      `Частка оприлюднених` = paste0((sum(aux1) / n())*100, '%'),
      `Частка вчасно оприлюднених` = paste0(round((`Оприлюднено вчасно` / n())*100,2), '%'),
      .by = Розпорядник
    ) |> select(-aux1)

published_data_agg <- published_data |> 
  distinct(Розпорядник,  `Підлягають оприлюдненню`, 
           `Оприлюднено наборів`, `Частка оприлюднених`, `Оприлюднено вчасно`, `Частка вчасно оприлюднених`) |>
  arrange(desc(`Підлягають оприлюдненню`), desc(`Оприлюднено наборів`))

# це 24 розпорядники, які оприлюднили усі набори 
published_data_agg |> filter(`Частка оприлюднених` == '100%') |> nrow()

# це 9 розпорядників, які не оприлюднили жодного
published_data_agg |> filter(`Частка оприлюднених` == '0%') |> nrow()
published_data_agg |> filter(`Частка оприлюднених` == '0%')

# це частка тих, хто має оприлюднити лише один набір - 54%
published_data_agg |> filter(`Підлягають оприлюдненню` == 1) |> nrow() /
  37

# загалом, оприлюднено 76.8% наборів від тих, що мають бути оприлюдненні
published_data_agg |> summarise(sum_n = sum(`Оприлюднено наборів`) / sum(`Підлягають оприлюдненню`))

published_data_agg |> summarise(sum_n = sum(`Оприлюднено наборів`))

# це 9 розпорядників, які вчасно оновили усі свої набори
published_data_agg |> filter(`Частка вчасно оприлюднених` == '100%') |> nrow()

# це 4, які принаймні щось оновили вчасно
published_data_agg |> filter(!`Частка вчасно оприлюднених` %in% c('100%', '0%')) |> nrow()

# це 24, які вчасно не оновили жоден зі свої наборів - або взагалі не опублікували нічого
published_data_agg |> filter(`Частка вчасно оприлюднених` %in% c('0%')) |> nrow()


published_data_agg |> summarise(sum_n = sum(`Оприлюднено вчасно`) / sum(`Підлягають оприлюдненню`))

published_data_agg |> summarise(sum_n = sum(`Оприлюднено вчасно`))
```

З 37 розпорядників визначених у постанові, найбільше наборів даних високої цінності мають оприлюднити Український національний офіс інтелектуальної власності та інновацій (10), Вища кваліфікаційна комісія суддів України (9), Мін’юст (8) та Вища рада правосуддя (5); понад половину розпорядників мають оприлюднити лише один такий набір.

Усі свої набори на Порталі відкритих даних оприлюднили 24 розпорядники, серед і них топ-3 розпорядників за кількістю наборів, що підлягають оприлюдненню. Жодного набору не оприлюднили 9 організацій, серед них Головний сервісний центр МВС та Національна поліція України, які мали б оприлюднити по 3 набори. Загалом, частка фактично оприлюднених наборів від тих, що підлягають оприлюдненню згідно з постановою складає 76.8%, тобто 63 набір з 82.

Станом на 01 листопада 2025 року вчасно оновили усі свої набори лише 9 розпорядників: серед них НКРЕКП (3/3) та Агентство відновлення (2/2). У 4 розпорядників є частина наборів, оновлених вчасно, у решти — оновлені невчасно, або взагалі відсутні. Загалом, частка оновлених вчасно наборів даних високої цінності від усіх наборів, що підлягають оприлюдненню, складає 35.4% — вчасно оновлено 29 наборів з 82.

```{r}
#| echo: false
color_green <- "#E8F5E9"
color_red <- "#FFEBEE"
color_yellow <- "#FFF8E1" # Додав жовтий для середніх показників (опціонально)

published_data_agg |>
  gt() |>
  
  # --- 1. ЛОГІЧНЕ ГРУПУВАННЯ (SPANNERS) ---
  tab_spanner(
    label = "Повнота",
    columns = c(`Підлягають оприлюдненню`, `Оприлюднено наборів`, `Частка оприлюднених`)
  ) |>
  tab_spanner(
    label = "Вчасність",
    columns = c(`Оприлюднено вчасно`, `Частка вчасно оприлюднених`)
  ) |>
  
  # --- 2. ФОРМАТУВАННЯ ЧИСЕЛ ---
  # Припускаємо, що частки — це числа від 0 до 1. 
  # Якщо у вас там вже текст "100%", цей крок треба пропустити.
  fmt_percent(
    columns = contains("Частка"),
    decimals = 0 
  ) |>
  fmt_number(
    columns = c(`Підлягають оприлюдненню`, `Оприлюднено наборів`, `Оприлюднено вчасно`),
    decimals = 0
  ) |>

  # --- 3. СКОРОЧЕННЯ НАЗВ КОЛОНОК ---
  # Оскільки ми додали групи зверху, назви колонок можна спростити
  cols_label(
    `Підлягають оприлюдненню` = "План",
    `Оприлюднено наборів` = "Факт",
    `Частка оприлюднених` = "% викон.",
    `Оприлюднено вчасно` = "Вчасно",
    `Частка вчасно оприлюднених` = "% вчасно"
  ) |>

  # --- 4. КОЛЬОРОВЕ КОДУВАННЯ (СВІТЛОФОР) ---
  
  # Зелений: Ідеально (100% оприлюднено)
  tab_style(
    style = cell_fill(color = color_green),
    locations = cells_body(
      columns = `Частка оприлюднених`,
      rows = `Частка оприлюднених` == '100%'
    )
  ) |>
  # Червоний: Критично мало (< 50%)
  tab_style(
    style = cell_fill(color = color_red),
    locations = cells_body(
      columns = `Частка оприлюднених`,
      rows = `Частка оприлюднених` == '0%'
    )
  ) |>
  tab_style(
    style = cell_fill(color = color_green),
    locations = cells_body(
      columns = `Частка вчасно оприлюднених`,
      rows = `Частка вчасно оприлюднених` == '100%'
    )
  ) |>
  # Для вчасності - аналогічно (низька вчасність - червоний)
  tab_style(
    style = cell_fill(color = color_red),
    locations = cells_body(
      columns = `Частка вчасно оприлюднених`,
      rows = `Частка вчасно оприлюднених` == '0%'
    )

  ) |>

  # --- 5. ЗАГОЛОВКИ ---
  tab_header(
    title = md("**Повнота оприлюднення та вчасність оновлення наборів**"),
  ) |>

  # --- 6. СТИЛІЗАЦІЯ ---
  cols_align(
    align = "left",
    columns = Розпорядник
  ) |>
  cols_align(
    align = "center",
    columns = -Розпорядник
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Розпорядник)
  ) |>
  # Виділимо колонки з відсотками жирним шрифтом, бо це KPI
  tab_style(
    style = cell_text(weight = 600),
    locations = cells_body(columns = contains("Частка"))
  ) |>
  tab_options(
    column_labels.font.weight = "bold",
    table.border.top.color = "gray50",
    table.border.bottom.color = "gray50",
    table_body.border.bottom.color = "gray90",
    data_row.padding = px(6)
  )
```

Слід зауважити, що перевіряючи вчасність оновлення, ми спираємося на дані, які віддає Портал відкритих даних через API. По 19 набору регулярність оновлення не зазначена, тому реальна кількість вчасно оновлених наборів може бути вищою.

```{r}
#| echo: false
color_red <- "#FFEBEE"

df |> 
  count(update_frequency) |>
  # 1. Переклад значень з англійської на українську
  mutate(update_frequency = case_match(update_frequency,
    "once a day" ~ "щодня",
    "once a week" ~ "щотижня",
    "once a month" ~ "щомісяця",
    "once a quarter" ~ "щокварталу",
    "once a half year" ~ "щопівроку",
    "once a year" ~ "щороку",
    "more than once a day" ~ "більше ніж раз на день",
    "immediately after making changes" ~ "невідкладно після змін",
    "no longer updated" ~ "не оновлюється",
    .default = update_frequency # Залишає без змін, якщо значення немає в списку
  )) |>
  # 2. Обробка NA (заміна на "немає даних")
  mutate(update_frequency = if_else(is.na(update_frequency), 
                                    'немає даних', 
                                    update_frequency)) |>
  rename(`Кількість наборів` = n, `Регулярність оновлення` = update_frequency) |>
  arrange(desc(`Кількість наборів`)) |>
  gt() |>
  # 3. Стиль для "немає даних" (світло-червоний)
  tab_style(
    style = cell_fill(color = color_red),
    locations = cells_body(
      columns = `Регулярність оновлення`,
      rows = `Регулярність оновлення` == "немає даних"
    )
  ) |>
  # 4. Основне оформлення
  tab_header(
    title = md("**Регулярність оновлення наборів**"),
    subtitle = md("Розподіл наборів даних за частотою")
  ) |>
  tab_style(
    style = cell_text(weight = "normal"),
    locations = cells_body(
      columns = `Регулярність оновлення`
    )
  ) |>
  grand_summary_rows(
    columns = `Кількість наборів`,
    fns = list(Всього = ~sum(., na.rm = TRUE)),
    fmt = ~ fmt_number(., decimals = 0)
  ) |>
  cols_align(
    align = "left",
    columns = `Регулярність оновлення`
  ) |>
  cols_align(
    align = "center",
    columns = `Кількість наборів`
  ) |>
  tab_options(
    column_labels.font.weight = "bold",
    table.border.top.color = "gray50",
    table.border.bottom.color = "gray50",
    table_body.border.bottom.color = "gray90",
    grand_summary_row.background.color = "white",
    data_row.padding = px(5)
  )
```

### Використовувані формати файлів у наборах високої цінності

63 опубліковані набори даних високої цінності складаються з 11,174 ресурсів (файлів). Найбільше ресурсів у наборі Державної судової адміністрації "Протоколи автоматизованого розподілу судових справ між суддями" — 9,379, при чому усі файли з цього набору розміщені у окремих ZIP-архівах. Через це архівів серед ресурсів наборів даних високої цінності найбільше, 87.3% від загальної кількості, або 9756 зі 11,174.

Інший погляд — подивитися за типами форматів ресурсів, які використовують розпорядники у своїх наборах. За такого погляду більшість розпорядників використовують лише структуровані формати файлів (ресурсів) при публікації наборів високої цінності.

```{r}
#| include: false

package_formats <- 
package_formats |> mutate(
  file_format2 = if_else(file_format2 != 'інші',
                         toupper(file_format2),
                         file_format2
                         ),
  file_format2 = str_remove(file_format2, '\\.')
) 

package_formats |> count(file_format_type) |> 
  mutate(n_share = percent(n/sum(n), .accuracy = 2)) |>
  rename(`Формат файлів` = file_format_type,
         `Частка` = n_share) |>
  select(-n) |>
  arrange(desc(Частка)) |>
  gt()
```

Серед структурованих форматів, найпопулярнішими є табличні формати XLS(X) та CSV/TSV. У 14% випадків використовується інтерфейс прикладного програмування (API). Серед структурованих форматів близько п'ятої частини припадає на ієрархічні формати — JSON та XML.

```{r}
#| include: false

# package_formats |> 
#   filter(file_format2 == 'API') 
# 
# package_formats |> 
#   filter(file_format_type == 'структурований') |>
#   count(file_format2) |> 
#   mutate(n_share = percent(n/sum(n), .accuracy = 2)) |>
#   str()

package_formats |> 
  filter(file_format_type == 'структурований') |>
  count(file_format2) |> 
  mutate(n_share = n/sum(n)) |>
  rename(`Формат структурованих файлів` = file_format2,
         `Частка` = n_share) |>
  select(-n) |>
  arrange(desc(Частка)) |>
  mutate(Частка = percent(Частка, .accuracy = .2)) |>
  gt()
```

Серед тих, хто використовує неструктуровані виділяються Конституційний суд, який публікує 96.8% усіх файлів у наборах високої цінності у неструктурованому форматі, а саме — DOC. Апарат Верховної Ради України поряд зі структурованими форматами використовує TXT, JPEG, HTML, DOC — що разом складають 32.9%. Агентство відновлення у 22.4% випадків використовує PDF та DOC.

```{r}
#| include: false

package_formats |> filter(file_format_type == 'неструктурований') |>
  filter(org_name_postanova %in% c('Конституційний Суд України', 'Верховна Рада України',
                                   'Агентство відновлення'))

package_formats |> summarise(sum_n = sum(n))

package_formats |> distinct(dataset_id) |> nrow()

package_formats |> filter(file_format_type == 'архіви') |> summarise(sum_n = sum(n))
```

```{r}
#| echo: false

color_green <- "#E8F5E9"
color_red <- "#FFEBEE"

package_formats |>
  pivot_wider(names_from = file_format_type, values_from = n) |>
  mutate(across(where(is.numeric), ~ replace_na(., 0))) |>
  summarise(
    архіви = sum(архіви),
    структ = sum(структурований),
    неструкт = sum(неструктурований),
    `не вказано` = sum(`не вказано`),
    .by = org_name_postanova
  ) |>
  rename(Розпорядник = org_name_postanova) |>
  mutate(
    n_total = архіви + структ + неструкт + `не вказано`,
    p_архівів = архіви / n_total,
    p_структ = структ / n_total,
    p_неструкт = неструкт / n_total
  ) |>
  select(-n_total, -`не вказано`) |>
  arrange(desc(p_неструкт)) |>
  gt() |>
  
  # --- 1. ФОРМАТУВАННЯ ЧИСЕЛ ---
  fmt_percent(
    columns = starts_with("p_"),
    decimals = 1
  ) |>
  # Форматуємо кількість (додаємо пробіли для тисяч, якщо треба)
  fmt_number(
    columns = c(архіви, структ, неструкт),
    decimals = 0,
    use_seps = TRUE 
  ) |>

  # --- 2. ГРУПУВАННЯ ЗАГОЛОВКІВ (SPANNERS) ---
  # Це додає "шапку" над групами колонок
  tab_spanner(
    label = "Кількість файлів",
    columns = c(архіви, структ, неструкт)
  ) |>
  tab_spanner(
    label = "Частка форматів",
    columns = starts_with("p_")
  ) |>

  # --- 3. КОЛЬОРОВЕ КОДУВАННЯ (ЛОГІКА) ---
  # Якщо неструктурованих > 50% -> Червоний
  tab_style(
    style = cell_fill(color = color_red),
    locations = cells_body(
      columns = p_неструкт,
      rows = p_неструкт > 0.5
    )
  ) |>
  # Якщо структурованих > 50% -> Зелений
  tab_style(
    style = cell_fill(color = color_green),
    locations = cells_body(
      columns = p_структ,
      rows = p_структ > 0.5
    )
  ) |>

  # --- 4. ЗАГОЛОВКИ ТА НАЗВИ ---
  cols_label(
    p_архівів = "Архіви",
    p_структ = "Структ.",
    p_неструкт = "Неструкт."
  ) |>
  tab_header(
    title = md("**Якість даних: Формати файлів**")
  ) |>

  # --- 5. СТИЛІЗАЦІЯ (Ті самі налаштування) ---
  # Вирівнювання: текст зліва, всі числа по центру
  cols_align(
    align = "left",
    columns = Розпорядник
  ) |>
  cols_align(
    align = "center",
    columns = -Розпорядник # Всі колонки, крім Розпорядника
  ) |>
  # Жирний шрифт для Розпорядника
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Розпорядник)
  ) |>
  # Глобальні опції
  tab_options(
    column_labels.font.weight = "bold",
    table.border.top.color = "gray50",
    table.border.bottom.color = "gray50",
    table_body.border.bottom.color = "gray90",
    data_row.padding = px(5)
  )

```

Проблема із використанням неструктурованих форматів полягає в тому, що такі формати потребують набагато більше часу на обробку для машинного використання, що створює непотрібні перешкоди для бізнесу, дослідників та громадян, які працюють з державними відкритими даними.

```{r}
#| include: false

setwd("C:/Users/MykolaKuzin/OneDrive - NGO 'BETTER REGULATION DELIVERY OFFICE'/Desktop/projects/open_data/github_high_value_datasets/high-value-open-datasets-ua/data")

writexl::write_xlsx(package_formats, 'resources_formats - 2025-11-01.xlsx')

writexl::write_xlsx(df, 'datasets_data - 2025-11-01.xlsx')

```
